{% extends 'base.html' %}
{% load humanize %}
{% block content %}
<div class="container py-4">

    <h2 class="mb-4 fw-bold">QUẢN LÝ DOANH THU</h2>

    <div class="mb-3">
        <a href="{% url 'order_statistics' %}" class="btn btn-outline-primary">Quản lý Đơn Hàng</a>
        <a href="{% url 'inventory_list' %}" class="btn btn-outline-primary">Quản lý kho</a>

    </div>

    <!-- FILTER FORM -->
    <div class="card shadow-sm p-3 mb-4">
        <form method="get" class="row g-2 align-items-end">
            <div class="col-auto">
                <label for="start_date" class="form-label mb-1">Từ ngày</label>
                <input type="date" id="start_date" name="start_date" class="form-control"
                       value="{{ start_date_str }}">
            </div>
            <div class="col-auto">
                <label for="end_date" class="form-label mb-1">Đến ngày</label>
                <input type="date" id="end_date" name="end_date" class="form-control"
                       value="{{ end_date_str }}">
            </div>
            <div class="col-auto">
                <button type="submit" class="btn btn-primary">Lọc</button>
                <a href="?" class="btn btn-outline-secondary">Xóa</a>
            </div>
        </form>

        {% if range_swapped %}
        <div class="mt-3">
            <div class="alert alert-warning mb-0 py-2">
                Start date lớn hơn End date — hệ thống đã đổi ngược lại giúp bạn.
            </div>
        </div>
        {% endif %}
    </div>

    <!-- 4 CARDS -->
    <div class="row mb-4">

        <div class="col-md-3">
            <div class="card shadow-sm p-3">
                <h5>Tổng đơn hàng</h5>
                <h3 class="text-primary">{{ total_orders }}</h3>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card shadow-sm p-3">
                <h5>Đơn PayPal</h5>
                <h3 class="text-success">{{ paypal_orders }}</h3>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card shadow-sm p-3">
                <h5>Đơn COD</h5>
                <h3 class="text-warning">{{ cod_orders }}</h3>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card shadow-sm p-3">
                <h5>Doanh thu</h5>
                <h3 class="text-danger">{{ total_revenue|intcomma }} ₫</h3>
            </div>
        </div>
    </div>

    <!-- CHART -->
    <div class="card shadow-sm p-3 mb-4">
        <h5>Thống kê {{ start_date_str }} → {{ end_date_str }}</h5>

        <canvas id="orderChart"></canvas>
        {{ chart_data|json_script:"chart-data" }}

        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script>
            const chartData = JSON.parse(document.getElementById('chart-data').textContent);
            const ctx = document.getElementById('orderChart').getContext('2d');

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartData.labels,
                    datasets: [{
                        label: 'Đơn hàng',
                        data: chartData.counts,
                        borderWidth: 2,
                        borderColor: 'rgba(13,110,253,0.85)',
                        backgroundColor: 'rgba(13,110,253,0.08)',
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true, precision: 0 }
                    }
                }
            });
        </script>
    </div>

    <!-- LATEST ORDERS TABLE -->
    <div class="card shadow-sm p-3">
        <h5>5 đơn mới nhất</h5>

        <table class="table">
            <thead>
                <tr>
                    <th>Mã đơn</th>
                    <th>Phương thức</th>
                    <th>Tổng</th>
                    <th>Trạng thái</th>
                </tr>
            </thead>
            <tbody>
                {% for order in latest_orders %}
                <tr>
                    <td>{{ order.id }}</td>
                    <td>{{ order.payment_method }}</td>
                    <td>{{ order.total_amount|intcomma }} ₫</td>
                    <td>{{ order.status }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="4" class="text-center text-muted">Không có đơn hàng</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

</div>
{% endblock %}